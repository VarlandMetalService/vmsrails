<% user_records = {} %>
<% provide(:title, 'Period Users') %>
<div class="row mt-3">
  <div class="col">
    <h3 class="mb-0">Employees for
        <%= @clock_period.start_date.strftime("%m/%d/%y") %> 
      - <%= @clock_period.end_date.strftime("%m/%d/%y") %>
    </h3>
  </div>
</div>
<div class="row mt-3">
  <div class="col">
    <h3 class="mb-0">
      </h3>
  </div>
</div>

<% @clock_period.clock_records.each do |record| %>
  <% if user_records[%Q[#{record.user.id}]].blank? %>
    <% array = [record] %>
    <% user_records.store(%Q[#{record.user.id}], array) %>
  <% else %>
    <% user_records[%Q[#{record.user.id}]] << record  %>
  <% end %>
<% end %>

<%= form_for @clock_period, url: holiday_hours_path do |f| %>

<div class="modal" tabindex="-1" role="dialog" id="mynewModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        Select Date for Holiday Entries
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
            <%= f.datetime_field "start_date", { class: "form-control" } %>
            <%= f.submit "Create Holiday Entries", class: "form-control" %>
        </p>
      </div>
    </div>
  </div>
</div>
<table class="table table-striped table-bordered">
  <thead class="thead-dark">
    <tr>
      <th><%= f.check_box "users", { :name => 'test', :multiple => true, id: 'check_all', :checked => false }, nil, nil %><sub>(all)</sub></th>
      <th>User</th>
      <th>Total</th>
      <th>Links</th>
      <th>Sun - <%=  @clock_period.start_date.strftime("%m/%d") %></th>
      <th>Mon - <%= (@clock_period.start_date + 1.day).strftime("%m/%d") %></th>
      <th>Tue - <%= (@clock_period.start_date + 2.day).strftime("%m/%d") %></th>
      <th>Wed - <%= (@clock_period.start_date + 3.day).strftime("%m/%d") %></th>
      <th>Thu - <%= (@clock_period.start_date + 4.day).strftime("%m/%d") %></th>
      <th>Fri - <%= (@clock_period.start_date + 5.day).strftime("%m/%d") %></th>
      <th>Sat - <%= (@clock_period.start_date + 6.day).strftime("%m/%d") %></th>
    </tr>
  </thead>
  <tbody>
  <% user_records.each do |user, records| %>
    <% week_rec = nil %>
    <% week_totals = nil %>
    <% week_rec = records_to_weeks(records) %>
    <% week_totals = calc_week_totals(week_rec) %>
    <tr>
      <td><%= f.check_box "users", {:multiple => true}, user, nil %></td>
      <td><%= User.find(user).full_name %></td>
      <td><%= (week_totals.sum*4).round / 4.0 %> hrs</td>
      <td class="text-center">
        <%= link_to fa_icon('eye'),
            user_summary_path(:id => @clock_period.id, :user_id => user),
            :action => :user_summary, 
            data: {turbolinks: false}, 
            class: "font-weight-bold btn btn-sm btn-success" %>
      </td>
      <% week_totals.each do |hours| %>
      <th><%= (hours*4).round / 4.0 %> hrs</th>
      <% end %>
    </tr>
    <% end %>
  </tbody>
</table>
<div class="btn-group">
<%= link_to fa_icon('arrow-left'),
                        timeclock_clock_periods_path,
                        method: :get,
                        class: 'font-weight-bold btn btn-sm btn-secondary',
                        title: 'Back' %>
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#mynewModal"> Create Holiday Shift for checked users </button>
</div>
<% end %>


<script type="text/javascript">
  var check_all = document.getElementById('check_all')
  check_all.addEventListener("click", function() {
    if(check_all.checked) {
      var cbxs = $('input[type="checkbox"]');
      cbxs.prop("checked", !cbxs.prop("checked"));
    }
    else {
      var cbxs = $('input[type="checkbox"]');
      cbxs.prop("checked", !cbxs.prop("checked"));
    }
  })
</script>

<script type="text/javascript">
  $(document).ready(function(){
    $('#check_all').on("click", function(){
    var cbxs = $('input[type="checkbox"]');
    cbxs.prop("checked", !cbxs.prop("checked"));
    });
  });
</script>